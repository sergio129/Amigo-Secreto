"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={38013:e=>{e.exports=require("mongodb")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},98603:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>v,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var r={};n.r(r),n.d(r,{GET:()=>l,POST:()=>p,PUT:()=>u});var i=n(49303),a=n(88716),s=n(60670),o=n(87070),d=n(38013),c=n(2021);async function l(e,{params:t}){try{let e=t.id;if(!e)return o.NextResponse.json({error:"ID de evento requerido"},{status:400});let n=(await c.Z).db("SaludDirecta"),r=await n.collection("amigo_secreto_events").findOne({_id:new d.ObjectId(e)});if(!r||!r.isActive)return o.NextResponse.json({error:"Evento no encontrado"},{status:404});let i=await n.collection("assignments").find({eventId:e}).toArray(),a=await n.collection("participants").find({eventId:e}).toArray(),s=new Map;a.forEach(e=>{s.set(e._id.toString(),e.name)});let l={};i.forEach(e=>{let t=s.get(e.giverId),n=s.get(e.receiverId);t&&n&&(l[t]=n)});let p=a.filter(e=>e.isRevealed).map(e=>e.name);return o.NextResponse.json({assignments:l,revealedParticipants:p,totalAssignments:i.length})}catch(e){return console.error("Error fetching assignments:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function p(e,{params:t}){return o.NextResponse.json({error:"Las asignaciones ahora se generan individualmente al revelar"},{status:400})}async function u(e,{params:t}){try{let n=t.id,{participantName:r}=await e.json();if(!n||!r)return o.NextResponse.json({error:"ID de evento y nombre del participante requeridos"},{status:400});let i=(await c.Z).db("SaludDirecta"),a=await i.collection("amigo_secreto_events").findOne({_id:new d.ObjectId(n)});if(!a||!a.isActive)return o.NextResponse.json({error:"Evento no encontrado"},{status:404});let s=await i.collection("participants").findOne({eventId:n,name:r});if(!s)return o.NextResponse.json({error:"Participante no encontrado"},{status:404});if(s.isRevealed)return o.NextResponse.json({error:"Participante ya revelado"},{status:400});let l=await i.collection("participants").find({eventId:n}).toArray(),p=await i.collection("assignments").find({eventId:n}).toArray(),u=new Set,v=new Set;p.forEach(e=>{u.add(e.receiverId),v.add(e.giverId)});let g=l.filter(e=>e._id.toString()!==s._id.toString()&&!u.has(e._id.toString()));if(0===g.length)return o.NextResponse.json({error:"No hay participantes disponibles para asignar"},{status:400});let m=Math.floor(Math.random()*g.length),f=g[m],w={eventId:n,giverId:s._id.toString(),receiverId:f._id.toString(),createdAt:new Date};return await i.collection("assignments").insertOne(w),await i.collection("participants").updateOne({_id:s._id},{$set:{isRevealed:!0,revealedAt:new Date}}),o.NextResponse.json({message:"Asignaci\xf3n generada y participante marcado como revelado",assignment:{giver:s.name,receiver:f.name},participant:{_id:s._id.toString(),name:s.name,isRevealed:!0,revealedAt:new Date}})}catch(e){return console.error("Error creating individual assignment:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/public/events/[id]/assignments/route",pathname:"/api/public/events/[id]/assignments",filename:"route",bundlePath:"app/api/public/events/[id]/assignments/route"},resolvedPagePath:"E:\\Proyectos\\Amigo Secreto\\app\\api\\public\\events\\[id]\\assignments\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=v,w="/api/public/events/[id]/assignments/route";function h(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2021:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(38013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let i=process.env.MONGODB_URI,a=new r.MongoClient(i,{}).connect()}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[276,972],()=>n(98603));module.exports=r})();