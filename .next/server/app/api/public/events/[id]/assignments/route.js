"use strict";(()=>{var e={};e.id=145,e.ids=[145],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8603:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>v,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var r={};n.r(r),n.d(r,{GET:()=>l,POST:()=>p,PUT:()=>u});var i=n(9303),a=n(8716),s=n(670),o=n(7070),d=n(8013),c=n(2021);async function l(e,{params:t}){try{let e=t.id;if(!e)return o.NextResponse.json({error:"ID de evento requerido"},{status:400});let n=(await c.Z).db("SaludDirecta");if(!await n.collection("amigo_secreto_events").findOne({_id:new d.ObjectId(e)}))return o.NextResponse.json({error:"Evento no encontrado"},{status:404});let r=await n.collection("assignments").find({eventId:e}).toArray(),i=await n.collection("participants").find({eventId:e}).toArray(),a=new Map;i.forEach(e=>{a.set(e._id.toString(),e.name)});let s={};r.forEach(e=>{let t=a.get(e.giverId),n=a.get(e.receiverId);t&&n&&(s[t]=n)});let l=i.filter(e=>e.isRevealed).map(e=>e.name);return o.NextResponse.json({assignments:s,revealedParticipants:l,totalAssignments:r.length})}catch(e){return console.error("Error fetching assignments:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}async function p(e,{params:t}){return o.NextResponse.json({error:"Las asignaciones ahora se generan individualmente al revelar"},{status:400})}async function u(e,{params:t}){try{let n=t.id,{participantName:r}=await e.json();if(!n||!r)return o.NextResponse.json({error:"ID de evento y nombre del participante requeridos"},{status:400});let i=(await c.Z).db("SaludDirecta");if(!await i.collection("amigo_secreto_events").findOne({_id:new d.ObjectId(n)}))return o.NextResponse.json({error:"Evento no encontrado"},{status:404});let a=await i.collection("participants").findOne({eventId:n,name:r});if(!a)return o.NextResponse.json({error:"Participante no encontrado"},{status:404});if(a.isRevealed)return o.NextResponse.json({error:"Participante ya revelado"},{status:400});let s=await i.collection("participants").find({eventId:n}).toArray(),l=await i.collection("assignments").find({eventId:n}).toArray(),p=new Set,u=new Set;l.forEach(e=>{p.add(e.receiverId),u.add(e.giverId)});let v=s.filter(e=>e._id.toString()!==a._id.toString()&&!p.has(e._id.toString()));if(0===v.length)return o.NextResponse.json({error:"No hay participantes disponibles para asignar"},{status:400});let g=Math.floor(Math.random()*v.length),m=v[g],f={eventId:n,giverId:a._id.toString(),receiverId:m._id.toString(),createdAt:new Date};return await i.collection("assignments").insertOne(f),await i.collection("participants").updateOne({_id:a._id},{$set:{isRevealed:!0,revealedAt:new Date}}),o.NextResponse.json({message:"Asignaci\xf3n generada y participante marcado como revelado",assignment:{giver:a.name,receiver:m.name},participant:{_id:a._id.toString(),name:a.name,isRevealed:!0,revealedAt:new Date}})}catch(e){return console.error("Error creating individual assignment:",e),o.NextResponse.json({error:"Error interno del servidor"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/public/events/[id]/assignments/route",pathname:"/api/public/events/[id]/assignments",filename:"route",bundlePath:"app/api/public/events/[id]/assignments/route"},resolvedPagePath:"E:\\Proyectos\\Amigo Secreto\\app\\api\\public\\events\\[id]\\assignments\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=v,w="/api/public/events/[id]/assignments/route";function h(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2021:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let i=process.env.MONGODB_URI,a=new r.MongoClient(i,{}).connect()}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[276,972],()=>n(8603));module.exports=r})();